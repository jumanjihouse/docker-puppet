box: wercker-labs/docker
no-response-timeout: 30
build:
  steps:
    - script:
        name: install docker
        code: curl -sSL https://get.docker.com/ubuntu/ | sudo sh
    - script:
        name: print system-wide docker info
        code: |
          docker version
          docker info
          docker images
    - script:
        name: remove existing containers if necessary
        code: script/00_build_start.sh
    - script:
        name: build puppet agent base image
        code: script/01_build_puppetagent.sh
    - script:
        name: build fixtures image
        code: script/02_build_fixtures.sh
    - script:
        name: build dns server
        code: script/05_build_named.sh
    - script:
        name: build puppetdb
        code: script/10_build_puppetdb.sh
    - script:
        name: build puppetmaster
        code: script/10_build_puppetmaster.sh
    - script:
        name: build puppetboard
        code: script/15_build_puppetboard.sh
    - script:
        name: build autostager
        code: script/20_build_autostager.sh
    - script:
        name: run the test suite
        code: script/test
    - script:
        name: scan puppetagent for vulnerabilities
        code: |
          docker run --rm -t jumanjiman/puppetagent  /oval/vulnerability-scan.sh || :
    - script:
        name: scan puppetdb for vulnerabilities
        code: |
          docker run --rm -t jumanjiman/puppetdb     /oval/vulnerability-scan.sh || :
    - script:
        name: scan puppetmaster for vulnerabilities
        code: |
          docker run --rm -t jumanjiman/puppetmaster /oval/vulnerability-scan.sh || :
    - zvelo/docker-save:
        image: jumanjiman/puppetagent:${WERCKER_GIT_COMMIT:0:7}
    - zvelo/docker-save:
        image: jumanjiman/puppetagent:latest
    - zvelo/docker-save:
        image: jumanjiman/puppetboard:${WERCKER_GIT_COMMIT:0:7}
    - zvelo/docker-save:
        image: jumanjiman/puppetboard:latest
    - zvelo/docker-save:
        image: jumanjiman/puppetdb:${WERCKER_GIT_COMMIT:0:7}
    - zvelo/docker-save:
        image: jumanjiman/puppetdb:latest
    - zvelo/docker-save:
        image: jumanjiman/puppetmaster:${WERCKER_GIT_COMMIT:0:7}
    - zvelo/docker-save:
        image: jumanjiman/puppetmaster:latest
    - zvelo/docker-save:
        image: jumanjiman/autostager:${WERCKER_GIT_COMMIT:0:7}
    - zvelo/docker-save:
        image: jumanjiman/autostager:latest
deploy:
  steps:
    - zvelo/docker-hub-push:
        image: jumanjiman/puppetagent:${WERCKER_GIT_COMMIT:0:7}
        email: ${email}
        password: ${password}
        username: jumanjiman
    - zvelo/docker-hub-push:
        image: jumanjiman/puppetagent:latest
        email: ${email}
        password: ${password}
        username: jumanjiman
    - zvelo/docker-hub-push:
        image: jumanjiman/puppetboard:${WERCKER_GIT_COMMIT:0:7}
        email: ${email}
        password: ${password}
        username: jumanjiman
    - zvelo/docker-hub-push:
        image: jumanjiman/puppetboard:latest
        email: ${email}
        password: ${password}
        username: jumanjiman
    - zvelo/docker-hub-push:
        image: jumanjiman/puppetdb:${WERCKER_GIT_COMMIT:0:7}
        email: ${email}
        password: ${password}
        username: jumanjiman
    - zvelo/docker-hub-push:
        image: jumanjiman/puppetdb:latest
        email: ${email}
        password: ${password}
        username: jumanjiman
    - zvelo/docker-hub-push:
        image: jumanjiman/puppetmaster:${WERCKER_GIT_COMMIT:0:7}
        email: ${email}
        password: ${password}
        username: jumanjiman
    - zvelo/docker-hub-push:
        image: jumanjiman/puppetmaster:latest
        email: ${email}
        password: ${password}
        username: jumanjiman
    - zvelo/docker-hub-push:
        image: jumanjiman/autostager:${WERCKER_GIT_COMMIT:0:7}
        email: ${email}
        password: ${password}
        username: jumanjiman
    - zvelo/docker-hub-push:
        image: jumanjiman/autostager:latest
        email: ${email}
        password: ${password}
        username: jumanjiman
